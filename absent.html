<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absence Tracking Dashboard</title>
    <style>
        /* Base styles and layout */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header and Stats */
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
        }

        .alert-badge {
            background: #ff4444;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: bold;
        }

        .warning-badge {
            background: #ff8800;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: bold;
        }

        /* Tabs and Content Sections */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
        }

        .content-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        /* Forms and Buttons */
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-section select, .filter-section input, .search-box {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            min-width: 200px;
            flex: 1;
        }
        
        .search-box {
            width: 100%;
            min-width: auto;
        }

        .btn, .btn-print {
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background 0.3s, transform 0.1s;
        }

        .btn {
            background: #667eea;
        }
        .btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-print {
            background: #4CAF50;
        }
        .btn-print:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        /* Tables and Reports */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border: 2px solid #667eea;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
            position: sticky;
            top: 0;
        }

        /* Specific Report Layouts */
        #rosterContent table, #weeklyContent table, #monthlyContent table {
            min-width: 800px; 
            /* Enforce nowrap for better column view, use overflow-x scroll on container */
        }
        #rosterContent th, #rosterContent td, #weeklyContent th, #weeklyContent td, #monthlyContent th, #monthlyContent td {
            white-space: nowrap;
        }

        /* Chart/Container Aesthetics */
        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .no-data, .loading {
            text-align: center;
            padding: 50px;
            color: #999;
            font-size: 1.2em;
        }
        .loading {
            color: #667eea;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .analytics-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .student-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-section {
                flex-direction: column;
            }

            .filter-section select, .filter-section input, .btn, .btn-print {
                width: 100%;
                min-width: auto;
            }
            .tabs {
                justify-content: center;
            }
            
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Print Styles (critical for weekly/monthly reports) */
        @media print {
            body { background: white !important; padding: 0; }
            .container { max-width: none; width: 100%; margin: 0; }
            /* Hide all UI elements except the active report content */
            .tabs, .stats-grid, #roster, #student, #analytics, #debug, .header p, .filter-section .btn, .filter-section .btn-print, .filter-section select, .filter-section input, .search-box { display: none !important; }
            
            .header { box-shadow: none; border-radius: 0; padding: 10px 0; margin-bottom: 10px; }
            .header h1 { font-size: 1.5em; color: black !important; }
            
            .content-section.active {
                display: block !important;
                position: absolute; left: 0; top: 0; padding: 10px; box-shadow: none; width: 100%;
            }
            
            .chart-container {
                box-shadow: none;
                border: 1px solid #ccc; 
                margin-top: 10px;
                padding: 10px;
                page-break-inside: avoid;
                page-break-after: always; /* Force page break between class tables */
            }
            
            table { 
                width: 100% !important; 
                font-size: 0.8em;
                table-layout: fixed;
            }
            
            th { 
                background: #667eea !important; 
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 4px 2px !important;
                font-size: 0.7em;
                word-wrap: break-word;
            }
            td {
                padding: 3px 2px !important;
                font-size: 0.75em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Student Absence Dashboard</h1>
            <p>Real-time absence tracking and analytics</p>
            <button class="btn" onclick="fetchData()" style="margin-top: 10px;">üîÑ Refresh Data</button>
            <p id="lastUpdate" style="color: #999; font-size: 0.9em; margin-top: 5px;"></p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Absent Lectures</h3>
                <div class="number" id="totalAbsentCount">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Students Tracked</h3>
                <div class="number" id="totalStudents">-</div>
            </div>
            <div class="stat-card">
                <h3>Chronic Absentees (>=21 Days)</h3>
                <div class="number" id="chronicAbsentees">-</div>
            </div>
            <div class="stat-card">
                <h3>Active Classes</h3>
                <div class="number" id="totalClasses">14</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('daily')">üìÖ Daily Report</div>
            <div class="tab" onclick="showTab('roster'); loadRoster();">üìã Class Roster</div>
            <div class="tab" onclick="showTab('weekly'); loadWeeklyDropdown();">üìä Weekly Report</div>
            <div class="tab" onclick="showTab('monthly'); loadMonthlyDropdown();">üìÖ Monthly Report</div>
            <div class="tab" onclick="showTab('student')">üë§ Student Search</div>
            <div class="tab" onclick="showTab('analytics')">üìà Analytics</div>
            <div class="tab" onclick="showTab('debug')">üêõ Debug</div>
        </div>

        <div id="daily" class="content-section active">
            <h2>Daily Absentee List</h2>
            <p style="color: #666; margin-bottom: 20px;">Lists all students reported absent for the selected date.</p>

            <div class="filter-section">
                <input type="date" id="dailyDateFilter" onchange="filterDaily()">
                <button class="btn" onclick="setToday()">Today</button>
            </div>
            <div id="dailyContent">
                <div class="loading">Loading data...</div>
            </div>
        </div>

        <div id="roster" class="content-section">
            <h2>Absence Summary by Class Roster</h2>
            <div class="filter-section">
                <select id="classRosterFilter" onchange="filterRoster()"></select>
                <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print Roster</button>
            </div>
            <div id="rosterContent">
                <div class="no-data">Select a class group to view student absence totals.</div>
            </div>
        </div>
        
        <div id="weekly" class="content-section">
            <h2>Historical Weekly Absence Reports</h2>
            
            <div class="filter-section">
                <select id="weeklyFilterDropdown" onchange="loadWeeklyReport()"></select>
                <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
            </div>

            <div id="weeklyContent">
                <div class="loading">Select a week to view report...</div>
            </div>
        </div>

        <div id="monthly" class="content-section">
            <h2>Monthly Absence Reports</h2>
            
            <div class="filter-section">
                <select id="monthlyFilterDropdown" onchange="loadMonthlyReport()"></select>
                <button class="btn-print" onclick="window.print()">üñ®Ô∏è Print Report</button>
            </div>

            <div id="monthlyContent">
                <div class="loading">Select a month to view report...</div>
            </div>
        </div>

        <div id="student" class="content-section">
            <h2>Student Absence Search</h2>
            <input type="text" class="search-box" id="studentSearch" placeholder="Type student name..." onkeyup="searchStudent()">
            <div id="studentContent">
                <div class="no-data">Enter a student name to search</div>
            </div>
        </div>

        <div id="analytics" class="content-section">
            <h2>Absence Analytics</h2>
            <div class="analytics-grid" id="analyticsContent">
                <div class="loading">Loading analytics...</div>
            </div>
        </div>

        <div id="debug" class="content-section">
            <h2>Debug Information</h2>
            <div id="debugContent">
                <div class="loading">Loading debug info...</div>
            </div>
        </div>
    </div>

    <script>
        // Use your published Google Sheets URL
        const PUBLISHED_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRhngDeX6ocdqEIVJqC6uUoEq_SNWN990JP1uO1Qh4iCcrTTFd7svXK9p1C4NVu8Mfcmxg25fkTpppD/pub?gid=853143084&single=true&output=csv';
        const SCHOOL_START_DATE = '9/21/2025';
        
        let classes = ['1A', '1B', '1C', '1D', '2A', '2B', '2C', '3A', '3B', '3C', '4PRO', '4WEB', '5NET', '5PRO'];
        
        let allData = [];
        let academicWeeks = [];
        let academicMonths = [];

        // Minimal fallback data for testing
        let fallbackData = [
            { timestamp: new Date(), date: '11/10/2025', teacher: 'Test Teacher', subject: 'Test Subject', lecture: 'Lecture 1', lectureMultiplier: 1, classGroup: '1A', absences: ['test student'] }
        ];

        /** Helper Functions **/

        function normalizeDate(dateString) {
            if (!dateString) return '';
            let date;
            
            if (typeof dateString === 'string') {
                // Try to parse as MM/DD/YYYY
                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        date = new Date(parts[2], parts[0] - 1, parts[1]);
                    }
                } else if (dateString.includes('-')) {
                    // Try to parse as YYYY-MM-DD (standard HTML date input format)
                    date = new Date(dateString);
                }
            } else if (dateString instanceof Date) {
                date = dateString;
            }
            
            if (!date || isNaN(date.getTime())) {
                return '';
            }
            
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const year = date.getFullYear();
            
            return `${month}/${day}/${year}`;
        }
        
        function formatDateForDisplay(dateObj) {
            if (!dateObj || isNaN(dateObj.getTime())) return '';
            const day = dateObj.getDate().toString().padStart(2, '0');
            const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            const year = dateObj.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function getLectureCount(lectureValue) {
            if (!lectureValue) return 1;
            const value = String(lectureValue).trim().toLowerCase();
            // Check for common patterns indicating two lectures
            if (value.includes('and') || value.includes(',') || value.includes('merged') || /\d\s*-\s*\d/.test(value)) {
                return 2;
            }
            return 1;
        }

        function getAllAcademicWeeks() {
            const start = new Date(SCHOOL_START_DATE);
            if (isNaN(start.getTime())) return [];
            start.setHours(0, 0, 0, 0);
            
            const weeks = [];
            let current = new Date(start);
            const now = new Date();
            now.setHours(23, 59, 59, 999);
            
            // Go to the start of the week (Sunday is 0, Monday is 1, etc.)
            const dayOffset = current.getDay();
            current.setDate(current.getDate() - dayOffset);
            
            let weekCounter = 1;

            while (current <= now) {
                const weekStart = new Date(current);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 4); // School week assumption: Mon-Fri (+4 days)
                weekEnd.setHours(23, 59, 59, 999);

                if (weekStart <= now) {
                    weeks.push({ 
                        number: weekCounter++, 
                        start: weekStart, 
                        end: weekEnd 
                    });
                }
                
                current.setDate(current.getDate() + 7);
            }
            return weeks.reverse();
        }

        function getAllAcademicMonths() {
            const start = new Date(SCHOOL_START_DATE);
            if (isNaN(start.getTime())) return [];
            start.setHours(0, 0, 0, 0);
            
            const months = [];
            // Start at the 1st of the month of the start date
            let current = new Date(start.getFullYear(), start.getMonth(), 1);
            const now = new Date();
            
            while (current <= now) {
                const monthStart = new Date(current);
                monthStart.setHours(0, 0, 0, 0);

                // Get the last day of the current month
                const monthEnd = new Date(current.getFullYear(), current.getMonth() + 1, 0);
                monthEnd.setHours(23, 59, 59, 999);

                if (monthStart <= now) {
                    months.push({ 
                        name: monthStart.toLocaleString('default', { month: 'long', year: 'numeric' }),
                        start: monthStart, 
                        end: monthEnd 
                    });
                }
                
                // Move to the next month
                current.setMonth(current.getMonth() + 1);
            }
            return months.reverse();
        }
        
        function isDateInWeekRange(dateString, weekStart, weekEnd) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return false;
            date.setHours(0, 0, 0, 0); 
            return date >= weekStart && date <= weekEnd;
        }

        function isDateInMonthRange(dateString, monthStart, monthEnd) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return false;
            date.setHours(0, 0, 0, 0); 
            return date >= monthStart && date <= monthEnd;
        }

        /** CSV Parser Functions **/

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                console.warn('‚ö†Ô∏è CSV has no data rows');
                return [];
            }
            
            // Parse header row
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            console.log('üìã CSV Headers:', headers);
            
            return lines.slice(1).map((line, index) => {
                try {
                    const values = parseCSVLine(line);
                    
                    // Create row object
                    const row = {};
                    headers.forEach((header, i) => {
                        row[header] = values[i] || '';
                    });
                    
                    // Map to your data structure
                    const timestamp = row['Timestamp'] || row['timestamp'] || new Date().toISOString();
                    const date = row['Q1: Date'] || row['Date'] || row['Timestamp'] || '';
                    const teacher = row['Q2: Teacher Name'] || row['Teacher Name'] || 'Unknown';
                    const subject = row['Q3: Subject'] || row['Subject'] || 'Unknown';
                    const lecture = row['Q4: Lecture No.'] || row['Lecture No.'] || 'Lecture 1';
                    const classGroup = row['Q5: Class Group'] || row['Class Group'] || '';
                    
                    // Find absent students column - dynamically look for any column containing "Absent"
                    let absentStudents = [];
                    for (const [key, value] of Object.entries(row)) {
                        if (key.toLowerCase().includes('absent') && value && value.trim()) {
                            const students = value.split(',').map(s => s.trim()).filter(s => s);
                            absentStudents = [...absentStudents, ...students];
                        }
                    }
                    
                    // If no absent column found, try common patterns
                    if (absentStudents.length === 0) {
                        const possibleColumns = [
                            'Absent Students', 'Absent', 'Students Absent', 
                            'Absent Students List', 'Absentees'
                        ];
                        for (const col of possibleColumns) {
                            if (row[col] && row[col].trim()) {
                                absentStudents = row[col].split(',').map(s => s.trim()).filter(s => s);
                                break;
                            }
                        }
                    }
                    
                    const lectureMultiplier = getLectureCount(lecture);
                    
                    return {
                        timestamp: new Date(timestamp),
                        date: date,
                        teacher: teacher,
                        subject: subject,
                        lecture: lecture,
                        lectureMultiplier: lectureMultiplier,
                        classGroup: classGroup,
                        absences: absentStudents
                    };
                    
                } catch (error) {
                    console.error(`‚ùå Error parsing CSV line ${index + 1}:`, error);
                    console.log('Problematic line:', line);
                    return null;
                }
            }).filter(row => row && row.date); // Filter out invalid rows
        }

        /** Main Data Fetcher **/

        async function fetchData() {
            document.getElementById('lastUpdate').textContent = 'Fetching data...';
            let currentData = [];

            try {
                console.log('üì• Fetching from:', PUBLISHED_SHEET_URL);
                
                const response = await fetch(PUBLISHED_SHEET_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('‚úÖ Raw CSV data received:', csvText.substring(0, 200) + '...');
                
                // Parse CSV data
                currentData = parseCSVData(csvText);
                console.log('‚úÖ Successfully parsed CSV data:', currentData.length, 'records');
                
            } catch (error) {
                console.error('‚ùå Error fetching published data:', error.message);
                console.log('üîÑ Using fallback data instead');
                currentData = [...fallbackData];
            }
            
            // Process the data
            allData = currentData.map(row => ({
                ...row,
                timestamp: row.timestamp instanceof Date ? row.timestamp : new Date(row.timestamp),
                date: normalizeDate(row.date)
            })).filter(row => row.date);
            
            academicWeeks = getAllAcademicWeeks();
            academicMonths = getAllAcademicMonths();

            // Update UI
            const now = new Date();
            document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleTimeString()}`;

            updateClassesFromData();
            updateDashboard();
            loadDaily();
            loadRoster();
            loadWeeklyDropdown();
            loadMonthlyDropdown();
            loadAnalytics();
            loadDebug();
        }

        /** Dashboard Statistics **/

        function updateClassesFromData() {
            const foundClasses = [...new Set(allData.map(row => row.classGroup).filter(Boolean))];
            if (foundClasses.length > 0) {
                classes = foundClasses.sort();
            }
            document.getElementById('totalClasses').textContent = classes.length;
        }

        function updateDashboard() {
            let totalAbsentCount = 0;
            let allUniqueStudents = new Set();
            
            const studentTotals = {};
            allData.forEach(row => {
                const multiplier = row.lectureMultiplier || 1; 
                const missedCount = row.absences.length * multiplier;
                totalAbsentCount += missedCount;
                
                row.absences.forEach(name => {
                    const studentName = name.toLowerCase();
                    allUniqueStudents.add(studentName);
                    
                    if (!studentTotals[studentName]) {
                        studentTotals[studentName] = 0;
                    }
                    studentTotals[studentName] += multiplier;
                });
            });

            // Calculate chronic absentees (>=21 days * 6 lectures/day = 126 lectures)
            let chronicAbsentees = 0;
            Object.values(studentTotals).forEach(totalLectures => {
                if (totalLectures >= 126) {
                    chronicAbsentees++;
                }
            });

            document.getElementById('totalAbsentCount').textContent = totalAbsentCount;
            document.getElementById('totalStudents').textContent = allUniqueStudents.size;
            document.getElementById('chronicAbsentees').textContent = chronicAbsentees;
        }

        /** Daily Report Logic **/

        function loadDaily() {
            if (!document.getElementById('dailyDateFilter').value) {
                setToday();
            } else {
                filterDaily(); 
            }
        }

        function setToday() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`; 
            
            document.getElementById('dailyDateFilter').value = todayString;
            filterDaily();
        }
        
        function getMostRecentDateWithData() {
            if (allData.length === 0) return null;
            
            const dates = allData.map(row => new Date(row.date)).filter(d => !isNaN(d.getTime()));
            if (dates.length === 0) return null;
            
            dates.sort((a, b) => b - a);
            return dates[0];
        }

        function filterDaily() {
            const selectedDateValue = document.getElementById('dailyDateFilter').value;
            if (!selectedDateValue) return;

            const filterString = normalizeDate(selectedDateValue); 
            let filtered = allData.filter(row => row.date === filterString);
            
            if (filtered.length === 0) {
                const allDates = [...new Set(allData.map(row => row.date))].sort();
                const mostRecent = getMostRecentDateWithData();
                
                let html = '<div class="no-data">';
                html += `<p>No absences recorded for <strong>${filterString}</strong>.</p>`;
                
                if (allDates.length > 0) {
                    html += '<p style="margin-top: 15px; color: #667eea;">Dates with recorded absences:</p>';
                    html += '<ul style="list-style: none; padding: 10px; text-align: left; display: inline-block;">';
                    allDates.forEach(date => {
                        html += `<li style="padding: 5px;">üìÖ ${date}</li>`;
                    });
                    html += '</ul>';
                    
                    if (mostRecent) {
                        const recentYear = mostRecent.getFullYear();
                        const recentMonth = String(mostRecent.getMonth() + 1).padStart(2, '0');
                        const recentDay = String(mostRecent.getDate()).padStart(2, '0');
                        const recentString = `${recentYear}-${recentMonth}-${recentDay}`;
                        
                        html += `<p style="margin-top: 15px;"><button class="btn" onclick="document.getElementById('dailyDateFilter').value='${recentString}'; filterDaily();">View Most Recent (${normalizeDate(recentString)})</button></p>`;
                    }
                }
                html += '</div>';
                
                document.getElementById('dailyContent').innerHTML = html;
                return;
            }
            
            // Group data by class
            const byClass = {};
            filtered.forEach(row => {
                const classGroup = row.classGroup;
                if (!byClass[classGroup]) {
                    byClass[classGroup] = {};
                }
                
                const lectureStr = String(row.lecture).trim();
                let lectureNumbers = [];
                const matches = lectureStr.match(/\d+/g);
                if (matches) {
                    lectureNumbers = matches.map(n => parseInt(n)).filter(n => n >= 1 && n <= 6);
                }
                
                if (lectureNumbers.length === 0) {
                    lectureNumbers = [1];
                }
                
                lectureNumbers.forEach(lectureNum => {
                    if (!byClass[classGroup][lectureNum]) {
                        byClass[classGroup][lectureNum] = {
                            subject: row.subject,
                            teacher: row.teacher,
                            students: []
                        };
                    }
                    
                    row.absences.forEach(student => {
                        if (!byClass[classGroup][lectureNum].students.includes(student)) {
                            byClass[classGroup][lectureNum].students.push(student);
                        }
                    });
                });
            });

            if (Object.keys(byClass).length === 0) {
                 document.getElementById('dailyContent').innerHTML = `<div class="no-data">No absences found on this date.</div>`;
                 return;
            }

            let html = '';
            const sortedClasses = Object.keys(byClass).sort();
            
            sortedClasses.forEach(classGroup => {
                const lectureData = byClass[classGroup];
                
                html += `<div class="chart-container" style="margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 5px;">Class ${classGroup}</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">üìÖ Date: ${filterString}</p>
                    <div style="overflow-x: auto;">
                        <table style="border: 2px solid #667eea;">
                            <thead>
                                <tr>
                                    <th style="text-align: center; background: #667eea; color: white; border: 1px solid #5568d3;">Lecture 1</th>
                                    <th style="text-align: center; background: #667eea; color: white; border: 1px solid #5568d3;">Lecture 2</th>
                                    <th style="text-align: center; background: #667eea; color: white; border: 1px solid #5568d3;">Lecture 3</th>
                                    <th style="text-align: center; background: #667eea; color: white; border: 1px solid #5568d3;">Lecture 4</th>
                                    <th style="text-align: center; background: #667eea; color: white; border: 1px solid #5568d3;">Lecture 5</th>
                                    <th style="text-align: center; background: #667eea; color: white; border: 1px solid #5568d3;">Lecture 6</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #f8f9fa;">`;
                
                // Subject row
                for (let i = 1; i <= 6; i++) {
                    const lecture = lectureData[i];
                    html += `<td style="text-align: center; font-weight: bold; padding: 12px; border: 1px solid #ddd;">
                        ${lecture ? lecture.subject : '-'}
                    </td>`;
                }
                html += `</tr><tr>`;
                
                // Students row
                for (let i = 1; i <= 6; i++) {
                    const lecture = lectureData[i];
                    if (lecture && lecture.students.length > 0) {
                        const studentList = lecture.students.map(s => `‚Ä¢ ${s}`).join('<br>');
                        html += `<td style="vertical-align: top; padding: 12px; border: 1px solid #ddd;">
                            <div style="color: #c33; font-weight: 500;">${studentList}</div>
                        </td>`;
                    } else {
                        html += `<td style="text-align: center; color: #999; padding: 12px; border: 1px solid #ddd;">-</td>`;
                    }
                }
                html += `</tr><tr style="background: #f8f9fa;">`;
                
                // Teacher row
                for (let i = 1; i <= 6; i++) {
                    const lecture = lectureData[i];
                    html += `<td style="text-align: center; font-style: italic; color: #666; padding: 12px; border: 1px solid #ddd;">
                        ${lecture ? lecture.teacher : '-'}
                    </td>`;
                }
                
                html += `</tr>
                            </tbody>
                        </table>
                    </div>
                </div>`;
            });

            document.getElementById('dailyContent').innerHTML = html;
        }

        /** Class Roster Logic **/

        function loadRoster() {
            const filter = document.getElementById('classRosterFilter');
            const availableClasses = classes.slice().sort(); 

            filter.innerHTML = '<option value="">-- Select Class Group --</option>';
            availableClasses.forEach(cls => {
                if (cls) {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls;
                    filter.appendChild(option);
                }
            });

            // If a class is already selected, re-filter. Otherwise, select the first one.
            const currentRosterClass = filter.value;
            if (currentRosterClass) {
                filterRoster();
            } else if (availableClasses.length > 0) {
                 filter.value = availableClasses[0];
                 filterRoster();
            } else {
                document.getElementById('rosterContent').innerHTML = '<div class="no-data">No class groups found in the data.</div>';
            }
        }

        function filterRoster() {
            const selectedClass = document.getElementById('classRosterFilter').value;
            const rosterContent = document.getElementById('rosterContent');

            if (!selectedClass) {
                rosterContent.innerHTML = '<div class="no-data">Select a class group to view student absence totals.</div>';
                return;
            }

            const studentSummary = {};
            const uniqueSubjects = new Set();
            
            allData.filter(row => row.classGroup === selectedClass)
                   .forEach(row => {
                       const multiplier = row.lectureMultiplier;
                       if (row.absences.length > 0) {
                           row.absences.forEach(studentName => {
                               if (!studentSummary[studentName]) {
                                   studentSummary[studentName] = {
                                       totalMissed: 0,
                                       subjects: {} 
                                   };
                               }
                               
                               studentSummary[studentName].totalMissed += multiplier;
                               
                               const subject = row.subject.trim();
                               studentSummary[studentName].subjects[subject] = (studentSummary[studentName].subjects[subject] || 0) + multiplier;
                               
                               uniqueSubjects.add(subject);
                           });
                       }
                   });

            const sortedStudents = Object.entries(studentSummary).sort((a, b) => b[1].totalMissed - a[1].totalMissed);
            const sortedSubjects = Array.from(uniqueSubjects).sort();

            if (sortedStudents.length === 0) {
                 rosterContent.innerHTML = `<div class="no-data">No recorded absences found for Class ${selectedClass}.</div>`;
                 return;
            }

            let html = `<h3>Absence Summary for Class ${selectedClass} (Total Lectures)</h3>`;
            html += '<div style="overflow-x: auto;">'; 
            html += '<table><thead><tr>';
            
            html += '<th style="min-width: 120px;">Student Name</th>';
            
            sortedSubjects.forEach(subject => {
                const shortSubject = subject.length > 15 ? subject.substring(0, 12) + '...' : subject;
                html += `<th title="${subject}" style="text-align: center;">${shortSubject}</th>`;
            });
            
            html += '<th style="text-align: center;">TOTAL</th>'; 
            html += '</tr></thead><tbody>';
            
            sortedStudents.forEach(([name, data]) => {
                html += '<tr>';
                html += `<td><strong>${name}</strong></td>`;
                
                let rowTotal = 0; 
                
                sortedSubjects.forEach(subject => {
                    const count = data.subjects[subject] || 0;
                    rowTotal += count; 
                    
                    const color = count >= 3 ? '#c33' : (count > 0 ? '#667eea' : '#666');
                    html += `<td style="text-align: center;"><span style="color: ${color}; font-weight: bold;">${count > 0 ? count : '-'}</span></td>`;
                });
                
                const totalColor = rowTotal >= 5 ? '#c33' : '#667eea';
                html += `<td style="text-align: center;"><strong style="color: ${totalColor};">${rowTotal}</strong></td>`;
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            rosterContent.innerHTML = html;
        }

        /** Weekly Report Logic **/

        function loadWeeklyDropdown() {
            const dropdown = document.getElementById('weeklyFilterDropdown');
            dropdown.innerHTML = '<option value="">-- Select Academic Week --</option>';

            academicWeeks.forEach((week, index) => {
                const range = `${formatDateForDisplay(week.start)} - ${formatDateForDisplay(week.end)}`;
                
                const option = document.createElement('option');
                option.value = index; 
                option.textContent = `Week ${week.number}: (${range})`;
                dropdown.appendChild(option);
            });
            
            if (academicWeeks.length > 0) {
                // Keep selected value if it exists, otherwise select the latest week (index 0)
                if (dropdown.value === "") {
                    dropdown.value = 0;
                }
                loadWeeklyReport();
            } else {
                document.getElementById('weeklyContent').innerHTML = '<div class="no-data">No academic weeks found since the school start date.</div>';
            }
        }

        function loadWeeklyReport() {
            const dropdown = document.getElementById('weeklyFilterDropdown');
            const selectedIndex = parseInt(dropdown.value);
            const weeklyContent = document.getElementById('weeklyContent');
            
            if (isNaN(selectedIndex) || selectedIndex < 0 || !academicWeeks[selectedIndex]) {
                weeklyContent.innerHTML = '<div class="loading">Select a week to view report...</div>';
                return;
            }

            const week = academicWeeks[selectedIndex];
            
            const weekData = allData.filter(row => {
                return isDateInWeekRange(row.date, week.start, week.end);
            });

            if (weekData.length === 0) {
                weeklyContent.innerHTML = `<div class="no-data">No absences reported during Week ${week.number} (${formatDateForDisplay(week.start)} - ${formatDateForDisplay(week.end)}).</div>`;
                return;
            }
            
            const weeklySummaryByClass = {};

            weekData.forEach(row => {
                const multiplier = row.lectureMultiplier; 
                const classGroup = row.classGroup;
                const subject = row.subject.trim();

                if (!weeklySummaryByClass[classGroup]) {
                    weeklySummaryByClass[classGroup] = { students: {} };
                }
                
                row.absences.forEach(studentName => {
                    if (!weeklySummaryByClass[classGroup].students[studentName]) {
                        weeklySummaryByClass[classGroup].students[studentName] = {
                            totalMissed: 0,
                            subjects: {} 
                        };
                    }
                    
                    const studentData = weeklySummaryByClass[classGroup].students[studentName];
                    studentData.totalMissed += multiplier;
                    studentData.subjects[subject] = (studentData.subjects[subject] || 0) + multiplier;
                });
            });

            const sortedClassGroups = Object.keys(weeklySummaryByClass).sort();
            const weekTitle = `${formatDateForDisplay(week.start)} - ${formatDateForDisplay(week.end)}`;
            
            let html = `<h3 style="color: #667eea; margin-bottom: 20px;">Week ${week.number}: (${weekTitle})</h3>`;

            sortedClassGroups.forEach(classGroup => {
                const studentsData = weeklySummaryByClass[classGroup].students;
                const sortedStudents = Object.entries(studentsData).sort((a, b) => b[1].totalMissed - a[1].totalMissed);

                if (sortedStudents.length === 0) return;
                
                const subjectsInThisClass = new Set();
                Object.values(studentsData).forEach(studentData => {
                    Object.keys(studentData.subjects).forEach(subject => {
                        if (studentData.subjects[subject] > 0) {
                            subjectsInThisClass.add(subject);
                        }
                    });
                });
                
                const sortedSubjectsForClass = Array.from(subjectsInThisClass).sort();
                const hasManySubs = sortedSubjectsForClass.length > 6;

                html += `<div class="chart-container" style="margin-bottom: 30px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">CLASS ${classGroup}</h4>
                            <div style="overflow-x: auto;">
                            <table style="border: 2px solid #667eea; ${hasManySubs ? 'font-size: 0.85em;' : ''}">
                                <thead>
                                    <tr>
                                        <th style="background: #667eea; color: white; border: 1px solid #5568d3; min-width: 100px;">Student</th>`;

                sortedSubjectsForClass.forEach(subject => {
                    const shortSubject = subject.length > 15 ? subject.substring(0, 12) + '...' : subject;
                    html += `<th style="background: #667eea; color: white; border: 1px solid #5568d3; text-align: center; padding: 4px 2px; min-width: 50px; max-width: 60px; font-size: 0.85em;" title="${subject}">${shortSubject}</th>`; 
                });
                
                html += `<th style="background: #667eea; color: white; border: 1px solid #5568d3; text-align: center; min-width: 60px; max-width: 70px; font-size: 0.9em; font-weight: bold;">TOTAL</th>
                            </tr></thead><tbody>`;
                
                sortedStudents.forEach(([name, data]) => {
                    html += '<tr>';
                    html += `<td style="font-weight: bold; border: 1px solid #ddd; padding: 6px;">${name}</td>`;
                    
                    sortedSubjectsForClass.forEach(subject => {
                        const count = data.subjects[subject] || 0;
                        
                        if (count > 0) {
                            const color = count >= 3 ? '#c33' : '#667eea';
                            html += `<td style="text-align: center; font-weight: bold; color: ${color}; border: 1px solid #ddd; padding: 4px; min-width: 50px; max-width: 60px;">${count}</td>`;
                        } else {
                            html += `<td style="text-align: center; color: #ccc; border: 1px solid #ddd; padding: 4px; min-width: 50px; max-width: 60px;">-</td>`;
                        }
                    });
                    
                    const totalColor = data.totalMissed >= 5 ? '#c33' : '#667eea';
                    html += `<td style="text-align: center; font-weight: bold; color: ${totalColor}; font-size: 1.1em; border: 1px solid #ddd; padding: 4px; min-width: 60px; max-width: 70px;">${data.totalMissed}</td>`;
                    html += '</tr>';
                });

                html += `</tbody></table></div></div>`;
            });

            weeklyContent.innerHTML = html;
        }

        /** Monthly Report Logic **/

        function loadMonthlyDropdown() {
            const dropdown = document.getElementById('monthlyFilterDropdown');
            dropdown.innerHTML = '<option value="">-- Select Academic Month --</option>';

            academicMonths.forEach((month, index) => {
                const range = `${formatDateForDisplay(month.start)} - ${formatDateForDisplay(month.end)}`;
                
                const option = document.createElement('option');
                option.value = index; 
                option.textContent = `${month.name} (${range})`;
                dropdown.appendChild(option);
            });
            
            if (academicMonths.length > 0) {
                if (dropdown.value === "") {
                    dropdown.value = 0; 
                }
                loadMonthlyReport();
            } else {
                document.getElementById('monthlyContent').innerHTML = '<div class="no-data">No academic months found since the school start date.</div>';
            }
        }

        function loadMonthlyReport() {
            const dropdown = document.getElementById('monthlyFilterDropdown');
            const selectedIndex = parseInt(dropdown.value);
            const monthlyContent = document.getElementById('monthlyContent');
            
            if (isNaN(selectedIndex) || selectedIndex < 0 || !academicMonths[selectedIndex]) {
                monthlyContent.innerHTML = '<div class="loading">Select a month to view report...</div>';
                return;
            }

            const month = academicMonths[selectedIndex];
            
            const monthData = allData.filter(row => {
                return isDateInMonthRange(row.date, month.start, month.end);
            });

            if (monthData.length === 0) {
                monthlyContent.innerHTML = `<div class="no-data">No absences reported during ${month.name} (${formatDateForDisplay(month.start)} - ${formatDateForDisplay(month.end)}).</div>`;
                return;
            }
            
            const monthlySummaryByClass = {};

            monthData.forEach(row => {
                const multiplier = row.lectureMultiplier;
                const classGroup = row.classGroup;
                const subject = row.subject.trim();

                if (!monthlySummaryByClass[classGroup]) {
                    monthlySummaryByClass[classGroup] = { students: {} };
                }

                row.absences.forEach(studentName => {
                    if (!monthlySummaryByClass[classGroup].students[studentName]) {
                        monthlySummaryByClass[classGroup].students[studentName] = {
                            totalMissed: 0,
                            subjects: {} 
                        };
                    }
                    
                    const studentData = monthlySummaryByClass[classGroup].students[studentName];
                    studentData.totalMissed += multiplier;
                    studentData.subjects[subject] = (studentData.subjects[subject] || 0) + multiplier;
                });
            });

            const sortedClassGroups = Object.keys(monthlySummaryByClass).sort();
            
            let html = `<h3 style="color: #667eea; margin-bottom: 20px;">Monthly Report: ${month.name}</h3>`;

            sortedClassGroups.forEach(classGroup => {
                const studentsData = monthlySummaryByClass[classGroup].students;
                const sortedStudents = Object.entries(studentsData).sort((a, b) => b[1].totalMissed - a[1].totalMissed);

                if (sortedStudents.length === 0) return;
                
                const subjectsInThisClass = new Set();
                Object.values(studentsData).forEach(studentData => {
                    Object.keys(studentData.subjects).forEach(subject => {
                        if (studentData.subjects[subject] > 0) {
                            subjectsInThisClass.add(subject);
                        }
                    });
                });
                
                const sortedSubjectsForClass = Array.from(subjectsInThisClass).sort();
                const hasManySubs = sortedSubjectsForClass.length > 6;

                html += `<div class="chart-container" style="margin-bottom: 30px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">CLASS ${classGroup}</h4>
                            <div style="overflow-x: auto;">
                            <table style="border: 2px solid #667eea; ${hasManySubs ? 'font-size: 0.85em;' : ''}">
                                <thead>
                                    <tr>
                                        <th style="background: #667eea; color: white; border: 1px solid #5568d3; min-width: 100px;">Student</th>`;

                sortedSubjectsForClass.forEach(subject => {
                    const shortSubject = subject.length > 15 ? subject.substring(0, 12) + '...' : subject;
                    html += `<th style="background: #667eea; color: white; border: 1px solid #5568d3; text-align: center; padding: 4px 2px; min-width: 50px; max-width: 60px; font-size: 0.85em;" title="${subject}">${shortSubject}</th>`; 
                });
                
                html += `<th style="background: #667eea; color: white; border: 1px solid #5568d3; text-align: center; min-width: 60px; max-width: 70px; font-size: 0.9em; font-weight: bold;">TOTAL</th>
                            </tr></thead><tbody>`;
                
                sortedStudents.forEach(([name, data]) => {
                    html += '<tr>';
                    html += `<td style="font-weight: bold; border: 1px solid #ddd; padding: 6px;">${name}</td>`;
                    
                    sortedSubjectsForClass.forEach(subject => {
                        const count = data.subjects[subject] || 0;
                        
                        if (count > 0) {
                            const color = count >= 6 ? '#c33' : '#ff8800'; 
                            html += `<td style="text-align: center; font-weight: bold; color: ${color}; border: 1px solid #ddd; padding: 4px; min-width: 50px; max-width: 60px;">${count}</td>`;
                        } else {
                            html += `<td style="text-align: center; color: #ccc; border: 1px solid #ddd; padding: 4px; min-width: 50px; max-width: 60px;">-</td>`;
                        }
                    });
                    
                    const totalColor = data.totalMissed >= 15 ? '#c33' : (data.totalMissed >= 5 ? '#ff8800' : '#667eea');
                    html += `<td style="text-align: center; font-weight: bold; color: ${totalColor}; font-size: 1.1em; border: 1px solid #ddd; padding: 4px; min-width: 60px; max-width: 70px;">${data.totalMissed}</td>`;
                    html += '</tr>';
                });

                html += `</tbody></table></div></div>`;
            });

            monthlyContent.innerHTML = html;
        }

        /** Student Search Logic **/

        function searchStudent() {
            const query = document.getElementById('studentSearch').value.toLowerCase().trim();
            
            if (!query) {
                document.getElementById('studentContent').innerHTML = '<div class="no-data">Enter a student name to search</div>';
                return;
            }

            const studentDetails = {};
            
            allData.forEach(row => {
                const multiplier = row.lectureMultiplier;
                row.absences.forEach(studentName => {
                    if (studentName.toLowerCase().includes(query)) {
                         if (!studentDetails[studentName]) {
                            studentDetails[studentName] = {
                                class: row.classGroup,
                                totalMissed: 0,
                                log: []
                            };
                        }
                        
                        studentDetails[studentName].totalMissed += multiplier;
                        
                        studentDetails[studentName].log.push({
                            date: row.date,
                            teacher: row.teacher,
                            subject: row.subject,
                            lecture: row.lecture,
                            missedCount: multiplier
                        });
                    }
                });
            });

            if (Object.keys(studentDetails).length === 0) {
                document.getElementById('studentContent').innerHTML = '<div class="no-data">No absences found for this student</div>';
                return;
            }
            
            let html = '';
            Object.entries(studentDetails).forEach(([name, data]) => {
                // Ensure logs are sorted newest first for the display
                data.log.sort((a, b) => new Date(b.date) - new Date(a.date));

                const subjects = [...new Set(data.log.map(a => a.subject))];
                html += `<div class="student-card">
                    <h4>${name} <span class="${data.totalMissed >= 10 ? 'alert-badge' : 'warning-badge'}">${data.totalMissed} Total Missed</span></h4>
                    <p><strong>Class:</strong> ${data.class}</p>
                    <p><strong>Subjects Missed:</strong> ${subjects.join(', ')}</p>
                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #667eea; font-weight: 600;">View Detailed Log (${data.log.length} Entries)</summary>
                        <div style="overflow-x: auto;">
                            <table style="margin-top: 10px;">
                                <thead><tr><th>Date</th><th>Lecture #</th><th>Lecs Missed</th><th>Subject</th><th>Teacher</th></tr></thead>
                                <tbody>`;
                
                data.log.forEach(a => {
                    html += `<tr>
                        <td>${a.date}</td>
                        <td>${a.lecture}</td>
                        <td><span style="font-weight: bold; color: ${a.missedCount > 1 ? '#c33' : '#667eea'};">${a.missedCount}</span></td>
                        <td>${a.subject}</td>
                        <td>${a.teacher}</td>
                    </tr>`;
                });
                
                html += `</tbody></table></div></details></div>`;
            });

            document.getElementById('studentContent').innerHTML = html;
        }

        /** Analytics Logic **/

        function loadAnalytics() {
            const byClass = {};
            classes.forEach(c => byClass[c] = 0);
            
            allData.forEach(row => {
                const multiplier = row.lectureMultiplier;
                if (row.classGroup) {
                    const normalizedClass = row.classGroup.toUpperCase().replace(/\s/g, '');
                    if (byClass.hasOwnProperty(normalizedClass)) {
                        byClass[normalizedClass] += row.absences.length * multiplier;
                    }
                }
            });

            const byLecture = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0};
            allData.forEach(row => {
                const multiplier = row.lectureMultiplier;
                // Simple attempt to get the first lecture number mentioned
                const lectureMatch = String(row.lecture).match(/\d+/); 
                const lecture = lectureMatch ? parseInt(lectureMatch[0]) : 0;
                
                if (lecture >= 1 && lecture <= 6) {
                    byLecture[lecture] += row.absences.length * multiplier;
                }
            });

            const bySubject = {};
            allData.forEach(row => {
                const multiplier = row.lectureMultiplier;
                if (row.subject) {
                    bySubject[row.subject] = (bySubject[row.subject] || 0) + (row.absences.length * multiplier);
                }
            });

            let html = '';
            
            // 1. Absences by Class
            html += '<div class="analytics-card"><h3>Absences by Class</h3><table><thead><tr><th>Class</th><th>Total Missed Lectures</th></tr></thead><tbody>';
            Object.entries(byClass).filter(([, count]) => count > 0).sort((a, b) => b[1] - a[1]).forEach(([cls, count]) => {
                html += `<tr><td>${cls}</td><td><strong>${count}</strong></td></tr>`;
            });
            html += '</tbody></table></div>';

            // 2. Absences by Lecture Time
            html += '<div class="analytics-card"><h3>Absences by Lecture Time</h3><table><thead><tr><th>Lecture #</th><th>Total Missed Lectures</th></tr></thead><tbody>';
            Object.entries(byLecture).forEach(([lec, count]) => {
                html += `<tr><td>Lecture ${lec}</td><td><strong>${count}</strong></tr>`;
            });
            html += '</tbody></table></div>';

            // 3. Absences by Subject
            html += '<div class="analytics-card" style="grid-column: span 2;"><h3>Absences by Subject</h3><table><thead><tr><th>Subject</th><th>Total Missed Lectures</th></tr></thead><tbody>';
            Object.entries(bySubject).filter(([, count]) => count > 0).sort((a, b) => b[1] - a[1]).forEach(([subj, count]) => {
                html += `<tr><td>${subj}</td><td><strong>${count}</strong></td></tr>`;
            });
            html += '</tbody></table></div>';

            document.getElementById('analyticsContent').innerHTML = html;
        }

        /** Debug Tab Logic **/

        function loadDebug() {
            const now = new Date();
            const todayNormalized = normalizeDate(now);
            
            let html = '<div class="chart-container"><h3>Current System Status</h3>';
            html += `<p><strong>Today's Date:</strong> ${now.toLocaleDateString()} (${now.toISOString()})</p>`;
            html += `<p><strong>Today Normalized:</strong> ${todayNormalized}</p>`;
            html += `<p><strong>Total Records:</strong> ${allData.length}</p>`;
            html += `<p><strong>Data Source:</strong> ${PUBLISHED_SHEET_URL}</p>`;
            html += '</div>';
            
            html += '<div class="chart-container"><h3>All Data Records</h3>';
            html += '<p>Shows parsed data after normalization. Check <strong>Normalized Date</strong> column for consistency.</p>';
            html += '<div style="overflow-x: auto;">';
            html += '<table><thead><tr><th>#</th><th>Raw Date</th><th>Normalized Date</th><th>Teacher</th><th>Class</th><th>Subject</th><th>Lectures</th><th>Absences Count</th></tr></thead><tbody>';
            
            allData.forEach((row, index) => {
                const normalized = row.date;
                const matchesToday = normalized === todayNormalized;
                const bgColor = matchesToday ? 'background: #d4edda;' : '';
                
                html += `<tr style="${bgColor}">
                    <td>${index + 1}</td>
                    <td>${row.date}</td>
                    <td><strong>${normalized}</strong> ${matchesToday ? '‚úÖ' : '‚ùå'}</td>
                    <td>${row.teacher}</td>
                    <td>${row.classGroup}</td>
                    <td>${row.subject}</td>
                    <td>${row.lecture} (x${row.lectureMultiplier})</td>
                    <td>${row.absences.length}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div></div>';
            
            html += '<div class="chart-container"><h3>Academic Periods</h3>';
            html += `<h4>Weeks (${academicWeeks.length}):</h4><ul style="list-style: none; padding: 0;">`;
            academicWeeks.slice(0, 5).forEach(w => html += `<li style="padding: 5px;">Week ${w.number}: ${formatDateForDisplay(w.start)} - ${formatDateForDisplay(w.end)}</li>`);
            html += '...</ul>';
            html += `<h4>Months (${academicMonths.length}):</h4><ul style="list-style: none; padding: 0;">`;
            academicMonths.forEach(m => html += `<li style="padding: 5px;">${m.name} (${formatDateForDisplay(m.start)} - ${formatDateForDisplay(m.end)})</li>`);
            html += '</ul></div>';

            document.getElementById('debugContent').innerHTML = html;
        }

        /** Tab Switching Logic **/
        
        function showTab(tabName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetSection = document.getElementById(tabName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Find the clicked tab based on text/content ID and activate it
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                if (tab.onclick && tab.onclick.toString().includes(`showTab('${tabName}')`)) {
                    tab.classList.add('active');
                }
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            // Refresh every 5 minutes (300,000 ms)
            setInterval(fetchData, 300000); 
        });
    </script>
</body>
</html>